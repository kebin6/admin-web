var H=Object.defineProperty;var _=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var S=(e,t,a)=>t in e?H(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,F=(e,t)=>{for(var a in t||(t={}))Q.call(t,a)&&S(e,a,t[a]);if(_)for(var a of _(t))W.call(t,a)&&S(e,a,t[a]);return e};var b=(e,t,a)=>new Promise((l,u)=>{var n=c=>{try{r(a.next(c))}catch(i){u(i)}},o=c=>{try{r(a.throw(c))}catch(i){u(i)}},r=c=>c.done?l(c.value):Promise.resolve(c.value).then(n,o);r((a=a.apply(e,t)).next())});import{_ as Y,a as J}from"./useForm-Cq3McrEd.js";import{b as X,as as Z,ar as x,aY as ee,o as te,bs as ae,a as D,v as oe,bl as ne,_ as se}from"./entry/index-DaEB-Y-8-1718870402071.js";import{u as N,c as re}from"./role-BtYuqNKr.js";import{l as ie,d as le,f as y,w as ue,c as ce,u as v,ab as g,_ as de,a7 as pe,ad as me,a8 as w,k as f,G as fe,a1 as he,ac as ye}from"./vue-BMCEF3Jf.js";import{Q as ge,E as K,a8 as we}from"./antd-BNMfrwLX.js";import{B as be,a as ke}from"./index-CL7BM-aX.js";import{_ as ve,a as De}from"./index-BQ8_-9UH.js";const{t:d}=X(),je=[{title:d("sys.role.roleName"),dataIndex:"trans",width:50},{title:d("sys.role.roleValue"),dataIndex:"code",width:20},{title:d("common.status"),dataIndex:"status",width:50,customRender:({record:e})=>(Reflect.has(e,"pendingStatus")||(e.pendingStatus=!1),ie(ge,{checked:e.status===1,checkedChildren:d("common.on"),unCheckedChildren:d("common.off"),loading:e.pendingStatus,onChange(t,a){const{createMessage:l}=x();if(e.id==1){l.warn(d("sys.role.adminStatusChangeForbidden"));return}e.pendingStatus=!0;const u=t?1:2;N({id:e.id,status:u}).then(()=>{e.status=u}).finally(()=>{e.pendingStatus=!1})}}))},{title:d("common.remark"),dataIndex:"remark",width:50},{title:d("common.createTime"),dataIndex:"createdAt",width:50,customRender:({record:e})=>Z(e.createdAt)}],Ae=[{field:"id",label:"ID",component:"Input",show:!1},{field:"name",label:d("sys.role.roleName"),required:!0,component:"Input",rules:[{max:30}]},{field:"sort",label:d("sys.menu.order"),defaultValue:0,component:"InputNumber",required:!0},{field:"code",label:d("sys.role.roleValue"),required:!0,component:"Input",rules:[{min:1,max:20}]},{field:"defaultRouter",label:d("sys.role.defaultRouter"),required:!0,component:"Input",rules:[{max:80}]},{field:"status",label:d("common.status"),component:"RadioButtonGroup",defaultValue:1,componentProps:{options:[{label:d("common.on"),value:1},{label:d("common.off"),value:0}]}},{label:d("common.remark"),field:"remark",component:"InputTextArea",rules:[{max:200}]}];function Te(e){var n,o;const t=[],a=[];if(e.length===0)return a;const l=new Map,u=new Map;for(let r=0;r<e.length;r++)l.set(e[r].group,e[r].serviceName),u.set(e[r].serviceName,!0);for(const r of l.keys()){const c={title:r,key:r,children:[]};for(let i=0;i<e.length;i++)e[i].group==r&&((n=c.children)==null||n.push({title:e[i].trans,key:e[i].id,disableCheckbox:e[i].isRequired}));a.push(c)}for(const r of u.keys()){const c={title:r,key:r,children:[]};for(let i=0;i<a.length;i++)l.get(a[i].title)===r&&((o=c.children)==null||o.push(ee(a[i])));t.push(c)}return t}function Me(e,t){const a=[];for(let n=0;n<e.length;n++)typeof e[n]=="number"&&a.push(e[n]);t.sort(function(n,o){return n.id!==void 0&&o.id!==void 0?n.id-o.id:1}),a.sort(function(n,o){return n-o});const l=[];let u=0;for(let n=0;n<t.length;n++)t[n].id===a[u]&&(l.push({path:t[n].path,method:t[n].method}),u++);return l}function B(e,t){const a=new Map,l=[],u=[];t.forEach(function(o,r){o.isRequired==!0&&u.push(o.id)});for(let o=0;o<t.length;o++)a.set(t[o].path+t[o].method,t[o].id);for(let o=0;o<e.length;o++)l.push(a.get(e[o].path+e[o].method));return te(ae(l,u))}const Ce=e=>D.post({url:"/sys-api/api/list",params:e}),Ie=e=>D.post({url:"/sys-api/authority/api/role",params:e}),Re=(e,t="notice")=>D.post({url:"/sys-api/authority/api/create_or_update",params:e},{errorMessageMode:t,successMessageMode:t}),_e=(e,t="notice")=>D.post({url:"/sys-api/authority/menu/create_or_update",params:e},{errorMessageMode:t,successMessageMode:t}),Se=e=>D.post({url:"/sys-api/authority/menu/role",params:e}),Fe=le({name:"RoleDrawer",components:{BasicDrawer:be,BasicForm:Y,ATabs:K,ATabPane:K.TabPane,ATree:we,BasicTree:ve},emits:["success","register"],setup(e,{emit:t}){const a=y(!0),{t:l}=oe.useI18n(),u=y("1");let n={code:0,msg:"",data:{total:0,data:[]}};const o=y(!1),r=()=>{o.value=!0},c=y(null),i=y([]);function k(){const s=v(c);if(!s)throw new Error("menu tree is null!");return s}function C(){return b(this,null,function*(){try{i.value=[];const s=yield ne();i.value=De(s.data.data,{idKeyField:"id",parentKeyField:"parentId",childrenKeyField:"children",valueField:"id",labelField:"trans"});const m=yield A(),M=yield Se({id:Number(m.id)});k().setCheckedKeys(M.data.menuIds),k().expandAll(!0)}catch(s){}})}const h=y([]),p=y([]);function P(){return b(this,null,function*(){try{p.value=[];const s=yield Ce({page:1,pageSize:1e4});n=s;const m=Te(s.data.data);for(const G in m)p.value.push(m[G]);const M=yield A(),R=yield Ie({id:Number(M.id)});R.data.data===null?h.value=B([],s.data.data):h.value=B(R.data.data,s.data.data)}catch(s){}})}ue(o,()=>{o.value===!0&&(C(),P())});const[q,{resetFields:O,setFieldsValue:U,validate:V,getFieldsValue:A}]=J({labelWidth:160,baseColProps:{span:24},layout:"vertical",schemas:Ae,showActionButtonGroup:!1}),[$,{setDrawerProps:I,closeDrawer:T}]=ke(s=>b(this,null,function*(){O(),I({confirmLoading:!1}),a.value=!!(s!=null&&s.isUpdate),v(a)&&U(F({},s.record))})),L=ce(()=>v(a)?l("sys.role.editRole"):l("sys.role.addRole"));function j(){o.value=!1,T()}function z(){return b(this,null,function*(){const s=yield V();I({confirmLoading:!0}),s.id=v(a)?Number(s.id):0,(v(a)?yield N(s):yield re(s)).code===0&&(o.value=!1,T(),t("success")),I({confirmLoading:!1})})}function E(){return b(this,null,function*(){if(u.value==="1"){const s=yield A();(yield _e({roleId:Number(s.id),menuIds:k().getCheckedKeys().checked})).code===0&&(o.value=!1,T())}else{const s=Me(h.value,n.data.data),m=yield A();(yield Re({roleId:Number(m.id),data:s})).code===0&&(o.value=!1,T())}})}return{t:l,isUpdate:a,activeKey:u,showChildrenDrawer:r,childrenDrawer:o,registerDrawer:$,registerForm:q,getTitle:L,handleSubmit:z,handleCancel:j,handleAuthorizationSubmit:E,treeMenuData:i,treeApiData:p,treeMenuRef:c,checkedApiKeys:h}}});function Ke(e,t,a,l,u,n){const o=g("a-button"),r=g("BasicForm"),c=g("BasicTree"),i=g("ATabPane"),k=g("ATree"),C=g("ATabs"),h=g("BasicDrawer");return de(),pe(h,ye(e.$attrs,{onRegister:e.registerDrawer,showFooter:"",title:e.getTitle,width:"500px",onOk:e.handleSubmit,onClose:e.handleCancel}),me({default:w(()=>[f(r,{onRegister:e.registerForm},null,8,["onRegister"]),f(h,{open:e.childrenDrawer,"onUpdate:open":t[2]||(t[2]=p=>e.childrenDrawer=p),title:e.t("sys.authority.authorityManagement"),width:"320",showFooter:"",closable:!0,onOk:e.handleAuthorizationSubmit,onClose:e.handleCancel},{default:w(()=>[f(C,{activeKey:e.activeKey,"onUpdate:activeKey":t[1]||(t[1]=p=>e.activeKey=p),centered:""},{default:w(()=>[f(i,{key:"1",tab:e.t("sys.authority.menuAuthority")},{default:w(()=>[f(c,{checkable:"",treeData:e.treeMenuData,checkStrictly:!0,noPadding:!0,ref:"treeMenuRef"},null,8,["treeData"])]),_:1},8,["tab"]),f(i,{key:"2",tab:e.t("sys.authority.apiAuthority")},{default:w(()=>[f(k,{"checked-keys":e.checkedApiKeys,"onUpdate:checkedKeys":t[0]||(t[0]=p=>e.checkedApiKeys=p),checkable:"","tree-data":e.treeApiData},null,8,["checked-keys","tree-data"])]),_:1},8,["tab"])]),_:1},8,["activeKey"])]),_:1},8,["open","title","onOk","onClose"])]),_:2},[e.isUpdate?{name:"extra",fn:w(()=>[f(o,{type:"primary",style:{"margin-right":"8px"},onClick:e.showChildrenDrawer},{default:w(()=>[fe(he(e.t("sys.authority.authorityManagement")),1)]),_:1},8,["onClick"])]),key:"0"}:void 0]),1040,["onRegister","title","onOk","onClose"])}const Be=se(Fe,[["render",Ke]]),ze=Object.freeze(Object.defineProperty({__proto__:null,default:Be},Symbol.toStringTag,{value:"Module"}));export{Be as R,ze as a,je as c};
